<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCM to WAV è½¬æ¢æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .audio-player {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        audio {
            width: 100%;
            margin-top: 10px;
        }
        .stats {
            margin-top: 20px;
            padding: 15px;
            background: #fff3e0;
            border-radius: 5px;
        }
        .stats div {
            margin: 5px 0;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .error {
            color: red;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: green;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ PCM to WAV è½¬æ¢æµ‹è¯•</h1>
        
        <div class="info">
            <strong>è¯´æ˜:</strong> æ­¤é¡µé¢ç”¨äºæµ‹è¯•å°† Gemini TTS è¿”å›çš„ L16 PCM éŸ³é¢‘æ•°æ®è½¬æ¢ä¸º WAV æ ¼å¼
        </div>

        <button onclick="testConversion()">ğŸ§ª æµ‹è¯•è½¬æ¢åŠŸèƒ½</button>
        <button onclick="analyzeAudio()">ğŸ“Š åˆ†æéŸ³é¢‘æ•°æ®</button>
        
        <div id="result"></div>
        
        <div class="audio-player" id="audioContainer" style="display:none;">
            <h3>è½¬æ¢åçš„éŸ³é¢‘:</h3>
            <audio id="audioPlayer" controls></audio>
        </div>
        
        <div class="stats" id="stats" style="display:none;">
            <h3>éŸ³é¢‘ç»Ÿè®¡ä¿¡æ¯:</h3>
            <div id="statsContent"></div>
        </div>
    </div>

    <script>
        // PCMè½¬WAVå‡½æ•°
        function pcmToWav(base64PcmData, sampleRate = 24000) {
            try {
                // è§£ç Base64
                const binaryString = atob(base64PcmData);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // PCMå‚æ•°
                const numChannels = 1; // å•å£°é“
                const bitsPerSample = 16; // 16ä½
                const byteRate = sampleRate * numChannels * bitsPerSample / 8;
                const blockAlign = numChannels * bitsPerSample / 8;
                const dataSize = bytes.length;
                
                // åˆ›å»ºWAVæ–‡ä»¶å¤´ (44å­—èŠ‚)
                const wavHeader = new ArrayBuffer(44);
                const view = new DataView(wavHeader);
                
                // RIFF chunk descriptor
                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + dataSize, true);
                writeString(view, 8, 'WAVE');
                
                // fmt sub-chunk
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bitsPerSample, true);
                
                // data sub-chunk
                writeString(view, 36, 'data');
                view.setUint32(40, dataSize, true);
                
                // åˆå¹¶å¤´éƒ¨å’Œæ•°æ®
                const wavData = new Uint8Array(44 + dataSize);
                wavData.set(new Uint8Array(wavHeader), 0);
                wavData.set(bytes, 44);
                
                return new Blob([wavData], { type: 'audio/wav' });
            } catch (error) {
                console.error('PCM to WAV conversion error:', error);
                throw error;
            }
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function analyzeAudioData(base64Data) {
            const binaryString = atob(base64Data.substring(0, 1000));
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            // è½¬æ¢ä¸º16ä½PCMæ ·æœ¬
            const samples = new Int16Array(bytes.buffer);
            
            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            let min = 32767, max = -32768, sum = 0, nonZero = 0;
            for (let i = 0; i < Math.min(samples.length, 1000); i++) {
                const sample = samples[i];
                min = Math.min(min, sample);
                max = Math.max(max, sample);
                sum += Math.abs(sample);
                if (sample !== 0) nonZero++;
            }
            
            return {
                totalBytes: atob(base64Data).length,
                sampleCount: Math.floor(atob(base64Data).length / 2),
                minValue: min,
                maxValue: max,
                avgAmplitude: Math.floor(sum / samples.length),
                nonZeroPercent: ((nonZero / samples.length) * 100).toFixed(2),
                firstSamples: Array.from(samples.slice(0, 20))
            };
        }

        async function testConversion() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨æµ‹è¯•è½¬æ¢...</div>';
            
            try {
                // æ¨¡æ‹Ÿä»APIè·å–PCMæ•°æ®(è¿™é‡Œä½¿ç”¨ä¸€ä¸ªç¤ºä¾‹,å®é™…åº”è¯¥ä»ä½ çš„TTSå“åº”ä¸­è·å–)
                const samplePcmBase64 = "AAAAAD8APwA/AD8APwA/AD8APwA/AD8APwA/AD8APwA/AAAAAAAAAD8AAAA/AD8A";
                
                // è½¬æ¢ä¸ºWAV
                const wavBlob = pcmToWav(samplePcmBase64, 24000);
                
                // åˆ›å»ºéŸ³é¢‘URL
                const audioUrl = URL.createObjectURL(wavBlob);
                
                // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = audioUrl;
                document.getElementById('audioContainer').style.display = 'block';
                
                resultDiv.innerHTML = `
                    <div class="success">
                        âœ… è½¬æ¢æˆåŠŸ!<br>
                        WAVæ–‡ä»¶å¤§å°: ${(wavBlob.size / 1024).toFixed(2)} KB<br>
                        é‡‡æ ·ç‡: 24000 Hz<br>
                        æ ¼å¼: 16-bit PCM, å•å£°é“
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è½¬æ¢å¤±è´¥: ${error.message}</div>`;
                console.error(error);
            }
        }

        async function analyzeAudio() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="info">æ­£åœ¨åˆ†æéŸ³é¢‘æ•°æ®...</div>';
            
            try {
                // ä½¿ç”¨ä½ æä¾›çš„å®é™…æ•°æ®ç‰‡æ®µ
                const sampleData = "AAAAAD8APwA/AD8APwA/AD8APwA/AD8APwA/AD8APwA/AAAAAAAAAD8AAAA/AD8A";
                
                const stats = analyzeAudioData(sampleData);
                
                document.getElementById('stats').style.display = 'block';
                document.getElementById('statsContent').innerHTML = `
                    <div><strong>æ€»å­—èŠ‚æ•°:</strong> ${stats.totalBytes.toLocaleString()}</div>
                    <div><strong>æ ·æœ¬æ•°:</strong> ${stats.sampleCount.toLocaleString()}</div>
                    <div><strong>æŒ¯å¹…èŒƒå›´:</strong> ${stats.minValue} ~ ${stats.maxValue}</div>
                    <div><strong>å¹³å‡æŒ¯å¹…:</strong> ${stats.avgAmplitude}</div>
                    <div><strong>éé›¶æ ·æœ¬:</strong> ${stats.nonZeroPercent}%</div>
                    <div><strong>å‰20ä¸ªæ ·æœ¬:</strong> ${stats.firstSamples.join(', ')}</div>
                    <div style="margin-top:10px; padding:10px; background:#fff3cd; border-radius:5px;">
                        ${stats.avgAmplitude < 100 ? 
                            'âš ï¸ <strong>è­¦å‘Š:</strong> å¹³å‡æŒ¯å¹…è¿‡ä½,éŸ³é¢‘å¯èƒ½å‡ ä¹é™éŸ³' : 
                            'âœ… éŸ³é¢‘æŒ¯å¹…æ­£å¸¸'}
                    </div>
                `;
                
                resultDiv.innerHTML = '<div class="success">âœ… åˆ†æå®Œæˆ,è¯·æŸ¥çœ‹ä¸‹æ–¹ç»Ÿè®¡ä¿¡æ¯</div>';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ åˆ†æå¤±è´¥: ${error.message}</div>`;
                console.error(error);
            }
        }
    </script>
</body>
</html>
